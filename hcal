#!/usr/bin/env python3
"""
hcal - A command-line calendar with highlighting and holiday support.
"""

import argparse
import calendar
import datetime
import re
import sys
from hcal_util import HighlightCalendar, read_config


def strip_ansi(text):
    """Strips ANSI escape codes from text."""
    ansi_escape = re.compile(r'\x1B(?:[@-Z\-_]|[0-?]*[@-~])')
    return ansi_escape.sub('', text)


def pad_line(line, width=20):
    """Pads a line with spaces to reach the specified visual width."""
    vis_len = len(strip_ansi(line))
    if vis_len < width:
        return line + ' ' * (width - vis_len)
    return line


def get_month_lines(cal, year, month):
    """Returns a list of padded strings for the month."""
    s = cal.formatmonth(year, month)
    lines = s.split('\n')
    # Remove empty last line if exists
    if lines and not lines[-1]:
        lines.pop()
    # Pad all lines to 20 visual chars
    padded = [pad_line(line) for line in lines]
    return padded


def main():
    """
    Main function to parse arguments and display the calendar.
    """
    parser = argparse.ArgumentParser(description="Show calendar on terminal", add_help=False)
    parser.add_argument('--help', action='help', default=argparse.SUPPRESS,
                        help='show this help message and exit')
    parser.add_argument('-h', action='store_true', dest='no_highlight',
                        help="Disable highlighting of today's date")
    parser.add_argument('-3', action='store_true', dest='three_months',
                        help='Display previous, current and next month')
    parser.add_argument('month', type=int, nargs='?', help="Month number (1-12)")
    parser.add_argument('year', type=int, nargs='?', help="Year (e.g. 2023)")

    args = parser.parse_args()

    now = datetime.datetime.now()

    year = args.year
    month = args.month

    # Logic for month/year inference
    if args.month is not None and args.year is None:
        if args.month > 12:
            year = args.month
            month = None  # Show whole year
        else:
            year = now.year
            month = args.month
    elif args.month is None and args.year is None:
        year = now.year
        month = now.month

    # Read config
    config = read_config("~/.hcalrc")
    country = config.get('country')

    # TextCalendar instance
    cal = HighlightCalendar(calendar.SUNDAY, today=now.date(), country=country,
                            highlight_today=not args.no_highlight)

    if args.three_months:
        if month is None:
             print("hcal: -3 option not valid with year", file=sys.stderr)
             return

        # Calculate prev and next
        def add_months(y, m, delta):
            m_new = m + delta
            y_new = y + (m_new - 1) // 12
            m_new = (m_new - 1) % 12 + 1
            return y_new, m_new

        py, pm = add_months(year, month, -1)
        ny, nm = add_months(year, month, 1)

        lines_p = get_month_lines(cal, py, pm)
        lines_c = get_month_lines(cal, year, month)
        lines_n = get_month_lines(cal, ny, nm)

        # Normalize height
        max_h = max(len(lines_p), len(lines_c), len(lines_n))
        
        def pad_height(lines, h):
            while len(lines) < h:
                lines.append(' ' * 20)
            return lines
        
        lines_p = pad_height(lines_p, max_h)
        lines_c = pad_height(lines_c, max_h)
        lines_n = pad_height(lines_n, max_h)
        
        # Join with 2 spaces gap
        for i in range(max_h):
            print(f"{lines_p[i]}  {lines_c[i]}  {lines_n[i]}")

    else:
        if month:
            print(cal.formatmonth(year, month))
        else:
            print(cal.formatyear(year))


if __name__ == "__main__":
    main()