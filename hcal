#!/usr/bin/env python3
"""
hcal - A command-line calendar with highlighting and holiday support.
"""

import argparse
import calendar
import datetime
import re
import sys
from itertools import groupby
from hcal_util import HighlightCalendar, read_config


MONTHS_IN_YEAR = 12


def strip_ansi(text):
    """Strips ANSI escape codes from text."""
    ansi_escape = re.compile(r'\x1B(?:[@-Z\\_-]|\[[0-?]*[ -/]*[@-~])')
    return ansi_escape.sub('', text)


def pad_line(line, width=20):
    """Pads a line with spaces to reach the specified visual width."""
    vis_len = len(strip_ansi(line))
    if vis_len < width:
        return line + ' ' * (width - vis_len)
    return line


def get_month_lines(cal, year, month):
    """Returns a list of padded strings for the month."""
    month_str = cal.formatmonth(year, month, w=cal.formatmonth_w)
    lines = month_str.split('\n')
    # Remove empty last line if exists
    if lines and not lines[-1]:
        lines.pop()
    # Pad all lines to visual chars
    padded = [pad_line(line, cal.month_width) for line in lines]
    return padded


def add_months(year, month, delta):
    """Calculates a new year and month given a delta."""
    m_new = month + delta
    y_new = year + (m_new - 1) // MONTHS_IN_YEAR
    m_new = (m_new - 1) % MONTHS_IN_YEAR + 1
    return y_new, m_new


def pad_height(lines, height, width=20):
    """Pads a list of lines with empty lines to match the specified height."""
    while len(lines) < height:
        lines.append(' ' * width)
    return lines


def print_month_list(cal, month_list):
    """Prints a list of (year, month) pairs in rows of 3."""
    for i in range(0, len(month_list), 3):
        chunk = month_list[i:i + 3]

        # Get lines for each month in chunk
        block_lines = [get_month_lines(cal, y, m) for y, m in chunk]

        # Normalize height
        max_h = max(len(lines) for lines in block_lines)

        # Pad all months to max_h
        block_lines = [pad_height(lines, max_h, cal.month_width) for lines in block_lines]

        # Print the block
        for row in range(max_h):
            # Join month lines with 2 spaces
            print("  ".join(block_lines[col][row] for col in range(len(chunk))))

        # Add empty line between blocks of months, but not after the last block
        if i + 3 < len(month_list):
            print()


def display_grouped_years(cal, month_list):
    """Displays months grouped by year with headers."""
    total_width = cal.month_width * 3 + 4
    year_groups = [list(g) for _, g in groupby(month_list, key=lambda item: item[0])]
    for i, group in enumerate(year_groups):
        year_val = group[0][0]
        print(str(year_val).center(total_width))
        print()
        print_month_list(cal, group)
        if i < len(year_groups) - 1:
            print()
            print()


def display_multiple_months(cal, year, month, count_after, count_before=0, show_year_headers=False):
    """Displays a range of months, 3 per row."""
    # pylint: disable=too-many-arguments, too-many-positional-arguments
    # Calculate all (year, month) pairs to display
    month_list = []
    # Start from month - count_before
    curr_y, curr_m = add_months(year, month, -count_before)
    total_months = count_before + 1 + count_after

    for _ in range(total_months):
        month_list.append((curr_y, curr_m))
        curr_y, curr_m = add_months(curr_y, curr_m, 1)

    if not show_year_headers:
        print_month_list(cal, month_list)
    else:
        display_grouped_years(cal, month_list)


def display_year(cal, year, extra_years=0, before_years=0):
    """Displays the whole year calendar with 3 months per row."""
    # pylint: disable=too-many-arguments, too-many-positional-arguments
    start_year = year - before_years
    total_years = before_years + 1 + extra_years
    total_width = cal.month_width * 3 + 4

    for i in range(total_years):
        curr_year = start_year + i
        # Print year centered
        # Standard width for 3 months: 20*3 + 2*2 = 64
        print(str(curr_year).center(total_width))
        print()  # Empty line after year header
        display_multiple_months(cal, curr_year, 1, MONTHS_IN_YEAR - 1,
                                show_year_headers=False)

        # Add empty lines between years, but not after the last year
        if i < total_years - 1:
            print()
            print()


def infer_year_month(args, now):
    """Infers the year and month to display based on arguments."""
    year = args.year
    month = args.month

    if args.year_option is not None:
        if args.year_option == -1:
            year = now.year
        else:
            year = args.year_option
        month = None
    elif args.month is not None and args.year is None:
        if args.month > MONTHS_IN_YEAR:
            year = args.month
            month = None  # Show whole year
        else:
            year = now.year
            month = args.month
    elif args.month is None and args.year is None:
        year = now.year
        month = now.month
    return year, month


def main():
    """
    Main function to parse arguments and display the calendar.
    """
    parser = argparse.ArgumentParser(description="Show calendar on terminal", add_help=False)
    parser.add_argument('--help', action='help', default=argparse.SUPPRESS,
                        help='show this help message and exit')
    parser.add_argument('-h', action='store_true', dest='no_highlight',
                        help="Disable highlighting of today's date")
    parser.add_argument('-3', action='store_true', dest='three_months',
                        help='Display previous, current and next month')
    parser.add_argument('-A', '--after', type=int, default=0,
                        help='Display specific numbers of months '
                             'after the current month (or year)')
    parser.add_argument('-B', '--before', type=int, default=0,
                        help='Display specific numbers of months '
                             'before the current month (or year)')
    parser.add_argument('-y', dest='year_option', type=int, nargs='?', const=-1,
                        help='Display a calendar for the specified year (default: current year)')
    parser.add_argument('-j', action='store_true', dest='julian',
                        help='Display Julian days (day of year)')
    parser.add_argument('month', type=int, nargs='?', help="Month number (1-12)")
    parser.add_argument('year', type=int, nargs='?', help="Year (e.g. 2023)")

    args = parser.parse_args()

    now = datetime.datetime.now()
    year, month = infer_year_month(args, now)

    # Read config
    config = read_config("~/.hcalrc")
    country = config.get('country')
    holiday_color = config.get('holiday_color', 'red')

    # TextCalendar instance
    cal = HighlightCalendar(calendar.SUNDAY, today=now.date(), country=country,
                            highlight_today=not args.no_highlight,
                            holiday_color=holiday_color, julian=args.julian)

    if month is None:
        if args.three_months:
            print("hcal: -3 option not valid with year", file=sys.stderr)
            return
        if args.after > 0 or args.before > 0:
            display_multiple_months(cal, year, 1, MONTHS_IN_YEAR - 1 + args.after,
                                    args.before, show_year_headers=True)
        else:
            display_year(cal, year, args.after, args.before)

    elif args.three_months or args.after > 0 or args.before > 0:
        count_before = max(1 if args.three_months else 0, args.before)
        count_after = max(1 if args.three_months else 0, args.after)
        display_multiple_months(cal, year, month, count_after, count_before)

    else:
        print(cal.formatmonth(year, month, w=cal.formatmonth_w))


if __name__ == "__main__":
    main()
