#!/usr/bin/env python3

import argparse
import calendar
import datetime
import sys

def main():
    parser = argparse.ArgumentParser(description="Show calendar on terminal")
    parser.add_argument('month', type=int, nargs='?', help="Month number (1-12)")
    parser.add_argument('year', type=int, nargs='?', help="Year (e.g. 2023)")
    
    args = parser.parse_args()
    
    now = datetime.datetime.now()
    
    year = args.year
    month = args.month
    
    # Handle logic:
    # hcal -> current month, current year
    # hcal 2024 -> whole year 2024
    # hcal 12 2024 -> Dec 2024
    
    # Adjusting for argparse behavior where positional args are filled in order
    # If user provides 1 arg:
    #   If it's > 12, assume it's a year.
    #   If it's <= 12, assume it's a month of current year? 
    #   Standard `cal` command behavior: `cal 2024` (year), `cal 12 2024` (month year).
    
    if args.month is not None and args.year is None:
        # One argument provided
        if args.month > 12:
            year = args.month
            month = None # Show whole year
        else:
            year = now.year
            month = args.month
    elif args.month is None and args.year is None:
        # No arguments
        year = now.year
        month = now.month
    
    # If both provided, use them as is (args.month, args.year)
    
    class HighlightCalendar(calendar.TextCalendar):
        def __init__(self, firstweekday=0, today_year=None, today_month=None, today_day=None):
            super().__init__(firstweekday)
            self.today_year = today_year
            self.today_month = today_month
            self.today_day = today_day
            self.curr_y = 0
            self.curr_m = 0

        def formatday(self, day, weekday, width):
            s = super().formatday(day, weekday, width)
            if day == 0: return s 
            
            # Check if this is today
            if (self.curr_y == self.today_year and 
                self.curr_m == self.today_month and 
                day == self.today_day):
                # White background (47), Black text (30) for contrast
                return f"\033[47;30m{s}\033[0m"
            
            # Weekend coloring
            if weekday == calendar.SUNDAY:
                return f"\033[31m{s}\033[0m" # Red
            elif weekday == calendar.SATURDAY:
                return f"\033[34m{s}\033[0m" # Blue

            return s

        def formatmonthname(self, theyear, themonth, width, withyear=True):
            s = super().formatmonthname(theyear, themonth, width, withyear)
            return f"\033[1;36m{s}\033[0m" # Bold Cyan

        def formatmonth(self, theyear, themonth, w=0, l=0):
            self.curr_y = theyear
            self.curr_m = themonth
            return super().formatmonth(theyear, themonth, w, l)

    # TextCalendar instance
    cal = HighlightCalendar(calendar.SUNDAY, now.year, now.month, now.day)
    
    if month:
        print(cal.formatmonth(year, month))
    else:
        print(cal.formatyear(year))

if __name__ == "__main__":
    main()
